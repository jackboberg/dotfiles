#!/usr/bin/env bash

# script/setup: Set up system for the first time after cloning

set -euo pipefail
IFS=$'\n\t'

setup () {
    cd "$(dirname "$0")/.."
    script/bootstrap

    echo "==> script/setup…"
    setup_rc
    setup_iterm
    setup_emacs
}

setup_iterm () {
    echo "==> Setting up iTerm2 preferences…"
    local dir

    # Specify the preferences directory
    dir="$(pwd)/iTerm2"
    defaults write com.googlecode.iterm2.plist PrefsCustomFolder -string "${dir}"

    # Tell iTerm2 to use the custom preferences in the directory
    defaults write com.googlecode.iterm2.plist LoadPrefsFromCustomFolder -bool true
}

setup_rc () {
    echo "==> Setting up RC files…"
    local dir

    # Set this repo as the source directory.
    dir=$(pwd)
    echo "DOTFILES_DIRS=\"${dir}\"" >> ./rcrc

    # First we symbolically link just the `rcrc` file, then allow that
    # configuration to drive the default linking strategy.
    rcup -d $dir rcrc
    rcup
}

setup_emacs () {
    echo "==> Setting up Emacs…"
    ghq get plexus/chemacs
    ghq get hlissner/doom-emacs
    ghq get syl20bnr/spacemacs
    $(ghq list -p plexus/chemacs)/install.sh
}

if [[ "${#BASH_SOURCE[@]}" -eq 1 ]]; then
    setup "$@"
fi
